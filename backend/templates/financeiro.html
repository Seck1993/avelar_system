{% extends 'base.html' %}
{% block content %}
    
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3><i class="fas fa-wallet text-warning"></i> Financeiro & Gasto Diário</h3>
        <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#modalDespesa">
            <i class="fas fa-minus-circle"></i> Lançar Despesa
        </button>
    </div>

    <ul class="nav nav-tabs border-secondary mb-3" id="finTab" role="tablist">
        <li class="nav-item">
            <button class="nav-link active text-white bg-dark border-secondary" data-bs-toggle="tab" data-bs-target="#diario">
                Gasto Diário (Lançamentos)
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link text-white bg-dark border-secondary" data-bs-toggle="tab" data-bs-target="#mensalidades">
                Controle de Mensalidades
            </button>
        </li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="diario">
            <div class="card-custom p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Categoria</th>
                                <th>Descrição / Vínculo</th>
                                <th>Valor</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for d in despesas %}
                            <tr>
                                <td class="text-white">{{ d.data.strftime('%d/%m/%Y') }}</td>
                                <td><span class="badge bg-secondary">{{ d.categoria }}</span></td>
                                <td class="text-white">
                                    {{ d.descricao }}
                                    {% if d.veiculo_id %}
                                    <br><small class="text-info"><i class="fas fa-car"></i> Frota</small>
                                    {% endif %}
                                    {% if d.funcionario_id %}
                                    <br><small class="text-warning"><i class="fas fa-user"></i> Equipe</small>
                                    {% endif %}
                                </td>
                                <td class="text-danger fw-bold">- R$ {{ "%.2f"|format(d.valor) }}</td>
                            </tr>
                            {% else %}
                            <tr><td colspan="4" class="text-center p-3 text-muted">Nenhuma despesa registrada.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="mensalidades">
            <div class="card-custom p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Vencimento</th>
                                <th>Cliente</th>
                                <th>Rota</th>
                                <th>Valor</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for m in mensalidades %}
                            <tr>
                                <td class="text-white">{{ m.mes_referencia }}</td>
                                <td class="text-white">{{ m.cliente.nome }}</td>
                                <td>
                                    {% if m.cliente.bairro_obj %}
                                        {{ m.cliente.bairro_obj.nome }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td class="text-white">R$ {{ "%.2f"|format(m.valor) }}</td>
                                <td>
                                    <span class="badge {{ 'bg-success' if m.status == 'Pago' else 'bg-warning text-dark' }}">
                                        {{ m.status }}
                                    </span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalDespesa" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-white border-secondary">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">Novo Lançamento</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form action="/nova_despesa" method="POST">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label>Data</label>
                            <input type="date" name="data" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label>Categoria</label>
                            <select name="categoria" class="form-select" required>
                                <option>Combustível</option>
                                <option>Manutenção Veículos</option>
                                <option>Funcionários / Diárias</option>
                                <option>Impostos / Taxas</option>
                                <option>Alimentação</option>
                                <option>Outros</option>
                            </select>
                        </div>
                        <div class="row mb-3">
                            <div class="col-6">
                                <label><small>Veículo (Opcional)</small></label>
                                <select name="veiculo_id" class="form-select form-select-sm">
                                    <option value="">- Nenhum -</option>
                                    {% for v in veiculos %}
                                    <option value="{{ v.id }}">{{ v.descricao }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-6">
                                <label><small>Funcionário (Opcional)</small></label>
                                <select name="funcionario_id" class="form-select form-select-sm">
                                    <option value="">- Nenhum -</option>
                                    {% for f in funcionarios %}
                                    <option value="{{ f.id }}">{{ f.nome }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label>Descrição</label>
                            <input type="text" name="descricao" class="form-control" required>
                        </div>
                        <div class="row">
                            <div class="col-6 mb-3">
                                <label>Valor (R$)</label>
                                <input type="number" step="0.01" name="valor" class="form-control" required>
                            </div>
                            <div class="col-6 mb-3">
                                <label>Tipo</label>
                                <select name="tipo" class="form-select">
                                    <option value="Empresa">Empresa</option>
                                    <option value="Pessoal">Pessoal</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer border-secondary">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-danger">Salvar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
{% endblock %}