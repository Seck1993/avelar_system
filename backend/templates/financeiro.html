{% extends 'base.html' %}
{% block content %}
    
<div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
    <h3><i class="fas fa-chart-pie text-warning"></i> Fluxo de Caixa</h3>
    
    <div class="btn-group">
        <a href="{{ url_for('financeiro', periodo='semana') }}" class="btn btn-outline-secondary {{ 'active' if filtro_atual == 'semana' }}">Semana</a>
        <a href="{{ url_for('financeiro', periodo='mes') }}" class="btn btn-outline-secondary {{ 'active' if filtro_atual == 'mes' }}">M√™s</a>
        <a href="{{ url_for('financeiro', periodo='ano') }}" class="btn btn-outline-secondary {{ 'active' if filtro_atual == 'ano' }}">Ano</a>
        <a href="{{ url_for('financeiro', periodo='tudo') }}" class="btn btn-outline-secondary {{ 'active' if filtro_atual == 'tudo' }}">Total</a>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-4">
        <div class="card-custom border-start border-success border-5 p-3">
            <h6 class="text-secondary text-uppercase mb-1">Total Entradas</h6>
            <h2 class="text-success fw-bold m-0">R$ {{ "%.2f"|format(total_entrada) }}</h2>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card-custom border-start border-danger border-5 p-3">
            <h6 class="text-secondary text-uppercase mb-1">Total Sa√≠das</h6>
            <h2 class="text-danger fw-bold m-0">R$ {{ "%.2f"|format(total_saida) }}</h2>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card-custom bg-dark border {{ 'border-success' if saldo >= 0 else 'border-danger' }} p-3" style="border: 1px solid;">
            <h6 class="text-white-50 text-uppercase mb-1">Saldo L√≠quido</h6>
            <h2 class="{{ 'text-success' if saldo >= 0 else 'text-danger' }} fw-bold m-0">
                R$ {{ "%.2f"|format(saldo) }}
            </h2>
        </div>
    </div>
</div>

<div class="row mb-3">
    <div class="col-md-6 d-flex gap-2 mb-2">
        <button class="btn btn-success w-50 fw-bold" data-bs-toggle="modal" data-bs-target="#modalEntrada">
            <i class="fas fa-arrow-up"></i> NOVA ENTRADA
        </button>
        <button class="btn btn-danger w-50 fw-bold" data-bs-toggle="modal" data-bs-target="#modalSaida">
            <i class="fas fa-arrow-down"></i> NOVA SA√çDA
        </button>
    </div>
    <div class="col-md-6">
        <input type="text" id="searchFluxo" class="form-control bg-dark text-white border-secondary" 
               onkeyup="filtrarTabela()" placeholder="üîç Pesquisar por data, descri√ß√£o, funcion√°rio, valor...">
    </div>
</div>

<div class="card-custom p-0">
    <div class="table-responsive">
        <table class="table table-dark table-hover mb-0 align-middle" id="tabelaFluxo">
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Tipo</th>
                    <th>Categoria</th>
                    <th>Descri√ß√£o / V√≠nculo</th>
                    <th>Valor</th>
                    <th class="text-end">A√ß√µes</th>
                </tr>
            </thead>
            <tbody>
                {% for item in fluxo %}
                <tr>
                    <td class="text-nowrap">{{ item.data.strftime('%d/%m/%Y') }}</td>
                    <td>
                        {% if item.tipo == 'Entrada' %}
                        <span class="badge bg-success"><i class="fas fa-arrow-up"></i> Entrada</span>
                        {% else %}
                        <span class="badge bg-danger"><i class="fas fa-arrow-down"></i> Sa√≠da</span>
                        {% endif %}
                    </td>
                    <td><span class="badge bg-secondary">{{ item.categoria }}</span></td>
                    <td>
                        <div class="fw-bold text-white">{{ item.descricao }}</div>
                        {% if item.vinculo != '-' %}
                        <small class="text-info"><i class="fas fa-link"></i> {{ item.vinculo }}</small>
                        {% endif %}
                    </td>
                    <td class="fw-bold {{ 'text-success' if item.tipo == 'Entrada' else 'text-danger' }}">
                        {{ '+' if item.tipo == 'Entrada' else '-' }} R$ {{ "%.2f"|format(item.valor) }}
                    </td>
                    <td class="text-end">
                        {% if item.origem == 'Lan√ßamento' %}
                        <a href="{{ url_for('excluir_cadastro', tipo='despesa', id=item.id) }}" 
                           class="btn btn-sm btn-outline-dark text-danger border-0"
                           onclick="return confirm('Excluir este lan√ßamento financeiro?')">
                            <i class="fas fa-trash"></i>
                        </a>
                        {% else %}
                        <span class="text-muted small" title="Venda Autom√°tica"><i class="fas fa-lock"></i></span>
                        {% endif %}
                    </td>
                </tr>
                {% else %}
                <tr><td colspan="6" class="text-center p-4 text-muted">Nenhum lan√ßamento neste per√≠odo.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="modalEntrada" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-white border-secondary">
            <div class="modal-header border-success">
                <h5 class="modal-title text-success"><i class="fas fa-arrow-up"></i> Registrar Entrada Extra</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form action="/novo_lancamento" method="POST">
                <input type="hidden" name="tipo_operacao" value="Entrada">
                <div class="modal-body">
                    <div class="mb-3">
                        <label>Data</label>
                        <input type="date" name="data" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label>Categoria</label>
                        <select name="categoria" class="form-select">
                            <option>Servi√ßo Extra</option>
                            <option>Venda de Equipamento</option>
                            <option>Investimento</option>
                            <option>Outros</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label>Descri√ß√£o</label>
                        <input type="text" name="descricao" class="form-control" placeholder="Ex: Venda de sucata" required>
                    </div>
                    <div class="mb-3">
                        <label>Valor (R$)</label>
                        <input type="number" step="0.01" name="valor" class="form-control text-success fw-bold" required>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="submit" class="btn btn-success w-100">Confirmar Entrada</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="modalSaida" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-white border-secondary">
            <div class="modal-header border-danger">
                <h5 class="modal-title text-danger"><i class="fas fa-arrow-down"></i> Registrar Sa√≠da / Despesa</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form action="/novo_lancamento" method="POST">
                <input type="hidden" name="tipo_operacao" value="Saida">
                <div class="modal-body">
                    <div class="mb-3">
                        <label>Data</label>
                        <input type="date" name="data" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label>Categoria</label>
                        <select name="categoria" class="form-select">
                            <option>Combust√≠vel</option>
                            <option>Manuten√ß√£o Ve√≠culo</option>
                            <option>Sal√°rio / Di√°ria</option>
                            <option>Alimenta√ß√£o</option>
                            <option>Material de Escrit√≥rio</option>
                            <option>Impostos</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label>Descri√ß√£o</label>
                        <input type="text" name="descricao" class="form-control" required>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-6">
                            <label class="small text-muted">Ve√≠culo (Opcional)</label>
                            <select name="veiculo_id" class="form-select form-select-sm">
                                <option value="">- Nenhum -</option>
                                {% for v in veiculos %}
                                <option value="{{ v.id }}">{{ v.descricao }} - {{ v.placa }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-6">
                            <label class="small text-muted">Funcion√°rio (Opcional)</label>
                            <select name="funcionario_id" class="form-select form-select-sm">
                                <option value="">- Nenhum -</option>
                                {% for f in funcionarios %}
                                <option value="{{ f.id }}">{{ f.nome }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label>Valor (R$)</label>
                        <input type="number" step="0.01" name="valor" class="form-control text-danger fw-bold" required>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="submit" class="btn btn-danger w-100">Confirmar Sa√≠da</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function filtrarTabela() {
    var input, filter, table, tr, td, i, txtValue;
    input = document.getElementById("searchFluxo");
    filter = input.value.toUpperCase();
    table = document.getElementById("tabelaFluxo");
    tr = table.getElementsByTagName("tr");

    for (i = 1; i < tr.length; i++) {
        var achou = false;
        var tds = tr[i].getElementsByTagName("td");
        for(var j=0; j < tds.length; j++){
            if(tds[j]){
                txtValue = tds[j].textContent || tds[j].innerText;
                if (txtValue.toUpperCase().indexOf(filter) > -1) {
                    achou = true;
                    break; 
                }
            }
        }
        tr[i].style.display = achou ? "" : "none";
    }
}
</script>

{% endblock %}